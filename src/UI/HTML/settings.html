<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexile Settings</title>
    <style>
        :root {
            --bg-color: rgba(30, 30, 30, 0.85);
            --primary-color: #4a90e2;
            --border-color: #555;
            --text-color: #fff;
            --secondary-bg: rgba(50, 50, 50, 0.7);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            background-color: var(--bg-color);
            padding: 20px;
        }

        .settings-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        h2 {
            color: var(--primary-color);
            margin: 25px 0 15px 0;
        }

        .settings-section {
            background-color: var(--secondary-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .setting-item {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .setting-label {
            font-size: 16px;
            flex: 1;
        }

        .setting-control {
            display: flex;
            align-items: center;
            min-width: 150px;
        }

        /* Checkbox styling */
        .checkbox-container {
            display: block;
            position: relative;
            padding-left: 35px;
            margin-bottom: 12px;
            cursor: pointer;
            font-size: 16px;
            user-select: none;
        }

        .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 25px;
            width: 25px;
            background-color: #333;
            border-radius: 4px;
        }

        .checkbox-container:hover input ~ .checkmark {
            background-color: #444;
        }

        .checkbox-container input:checked ~ .checkmark {
            background-color: var(--primary-color);
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }

        .checkbox-container .checkmark:after {
            left: 9px;
            top: 5px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }

        /* Slider styling */
        .slider-container {
            width: 100%;
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: #333;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .slider-value {
            margin-left: 10px;
            min-width: 40px;
            text-align: right;
        }

        /* Hotkey display */
        .hotkey-display {
            display: inline-block;
            background-color: #333;
            padding: 5px 10px;
            border-radius: 4px;
            min-width: 100px;
            text-align: center;
            margin-right: 10px;
        }

        .button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-size: 14px;
        }

        .button:hover {
            background-color: #3a80d2;
        }

        .button-small {
            padding: 3px 10px;
            font-size: 12px;
        }

        .buttons-container {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .buttons-container button {
            margin-left: 10px;
        }

        /* Recording state */
        .recording {
            background-color: #ff4d4d;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% {
                background-color: #ff8080;
            }
        }

        /* Select styling */
        select {
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border: 1px solid #555;
            border-radius: 4px;
            outline: none;
        }

        select:focus {
            border-color: var(--primary-color);
        }
    </style>
</head>
<body>
<div class="settings-container">
    <h1>Nexile Settings</h1>

    <div class="settings-section">
        <h2>General Settings</h2>

        <div class="setting-item">
            <span class="setting-label">Overlay Opacity</span>
            <div class="setting-control">
                <div class="slider-container">
                    <input type="range" min="20" max="100" value="80" class="slider" id="opacity-slider">
                </div>
                <span class="slider-value" id="opacity-value">80%</span>
            </div>
        </div>

        <div class="setting-item">
            <span class="setting-label">Click-through Overlay</span>
            <div class="setting-control">
                <label class="checkbox-container">
                    <input type="checkbox" id="click-through-checkbox" checked>
                    <span class="checkmark"></span>
                </label>
            </div>
        </div>

        <div class="setting-item">
            <span class="setting-label">Start with Windows</span>
            <div class="setting-control">
                <label class="checkbox-container">
                    <input type="checkbox" id="autostart-checkbox">
                    <span class="checkmark"></span>
                </label>
            </div>
        </div>

        <div class="setting-item">
            <span class="setting-label">Auto-detect Games</span>
            <div class="setting-control">
                <label class="checkbox-container">
                    <input type="checkbox" id="autodetect-checkbox" checked>
                    <span class="checkmark"></span>
                </label>
            </div>
        </div>

        <div class="setting-item">
            <span class="setting-label">Current Game</span>
            <div class="setting-control">
                <select id="game-select">
                    <option value="None">None</option>
                    <option value="PathOfExile">Path of Exile</option>
                    <option value="PathOfExile2">Path of Exile 2</option>
                    <option value="LastEpoch">Last Epoch</option>
                </select>
            </div>
        </div>
    </div>

    <div class="settings-section">
        <h2>Module Settings</h2>

        <div class="setting-item">
            <span class="setting-label">Price Check</span>
            <div class="setting-control">
                <label class="checkbox-container">
                    <input type="checkbox" id="price-check-checkbox" checked>
                    <span class="checkmark"></span>
                </label>
            </div>
        </div>

        <div class="setting-item">
            <span class="setting-label">Build Guide</span>
            <div class="setting-control">
                <label class="checkbox-container">
                    <input type="checkbox" id="build-guide-checkbox">
                    <span class="checkmark"></span>
                </label>
            </div>
        </div>

        <div class="setting-item">
            <span class="setting-label">Map Overlay</span>
            <div class="setting-control">
                <label class="checkbox-container">
                    <input type="checkbox" id="map-overlay-checkbox">
                    <span class="checkmark"></span>
                </label>
            </div>
        </div>
    </div>

    <div class="settings-section">
        <h2>Hotkey Settings</h2>

        <div class="setting-item">
            <span class="setting-label">Toggle Overlay</span>
            <div class="setting-control">
                <span class="hotkey-display" id="toggle-overlay-hotkey">Alt+Shift+O</span>
                <button class="button button-small" id="toggle-overlay-button">Change</button>
            </div>
        </div>

        <div class="setting-item">
            <span class="setting-label">Price Check</span>
            <div class="setting-control">
                <span class="hotkey-display" id="price-check-hotkey">Alt+P</span>
                <button class="button button-small" id="price-check-button">Change</button>
            </div>
        </div>

        <div class="setting-item">
            <span class="setting-label">Settings</span>
            <div class="setting-control">
                <span class="hotkey-display" id="settings-hotkey">Alt+Shift+S</span>
                <button class="button button-small" id="settings-button">Change</button>
            </div>
        </div>
    </div>

    <div class="buttons-container">
        <button class="button" id="defaults-button">Reset to Defaults</button>
        <button class="button" id="cancel-button">Cancel</button>
        <button class="button" id="save-button">Save</button>
    </div>
</div>

<script>
    // CEF JavaScript Bridge
    function sendMessage(data) {
        if (window.nexile && window.nexile.postMessage) {
            window.nexile.postMessage(data);
        } else if (window.chrome && window.chrome.webview && window.chrome.webview.postMessage) {
            // Fallback for compatibility
            window.chrome.webview.postMessage(JSON.stringify(data));
        } else {
            console.error('No message bridge available');
        }
    }

    // Initialize UI
    function initializeSettings() {
        // Get settings from native app
        sendMessage({
            action: 'get_settings'
        });

        // Initialize UI event handlers
        initializeEventHandlers();
    }

    // Initialize event handlers for UI elements
    function initializeEventHandlers() {
        // Opacity slider
        const opacitySlider = document.getElementById('opacity-slider');
        const opacityValue = document.getElementById('opacity-value');

        if (opacitySlider && opacityValue) {
            opacitySlider.addEventListener('input', function () {
                opacityValue.textContent = this.value + '%';
            });
        }

        // Hotkey buttons
        const toggleOverlayButton = document.getElementById('toggle-overlay-button');
        const priceCheckButton = document.getElementById('price-check-button');
        const settingsButton = document.getElementById('settings-button');

        if (toggleOverlayButton) {
            toggleOverlayButton.addEventListener('click', function () {
                startHotkeyRecording(1000, 'toggle-overlay-hotkey');
            });
        }

        if (priceCheckButton) {
            priceCheckButton.addEventListener('click', function () {
                startHotkeyRecording(1001, 'price-check-hotkey');
            });
        }

        if (settingsButton) {
            settingsButton.addEventListener('click', function () {
                startHotkeyRecording(1004, 'settings-hotkey');
            });
        }

        // Action buttons
        const saveButton = document.getElementById('save-button');
        const cancelButton = document.getElementById('cancel-button');
        const defaultsButton = document.getElementById('defaults-button');

        if (saveButton) {
            saveButton.addEventListener('click', function () {
                saveSettings();
            });
        }

        if (cancelButton) {
            cancelButton.addEventListener('click', function () {
                sendMessage({
                    action: 'cancel_settings'
                });
            });
        }

        if (defaultsButton) {
            defaultsButton.addEventListener('click', function () {
                sendMessage({
                    action: 'reset_settings'
                });
            });
        }

        // Handle key press for hotkey recording
        document.addEventListener('keydown', function (e) {
            if (currentlyRecordingHotkey) {
                e.preventDefault();

                // Check modifiers
                const ctrl = e.ctrlKey;
                const alt = e.altKey;
                const shift = e.shiftKey;

                // Get key code
                const key = e.keyCode;

                // Update UI
                let hotkeyText = '';
                if (ctrl) hotkeyText += 'Ctrl+';
                if (alt) hotkeyText += 'Alt+';
                if (shift) hotkeyText += 'Shift+';

                // Convert key code to string
                hotkeyText += keyCodeToString(key);

                // Update display
                const displayElement = document.getElementById(currentlyRecordingHotkeyElement);
                if (displayElement) {
                    displayElement.textContent = hotkeyText;
                    displayElement.classList.remove('recording');
                }

                // Send to native
                sendMessage({
                    action: 'hotkey_update',
                    hotkeyId: currentlyRecordingHotkeyId,
                    ctrl: ctrl,
                    alt: alt,
                    shift: shift,
                    key: key
                });

                // Reset recording state
                stopHotkeyRecording();
            }
        });
    }

    // Load settings into UI
    function loadSettings(settings) {
        console.log('Loading settings:', settings);

        // General settings
        if (settings.general) {
            // Opacity
            if (settings.general.opacity !== undefined) {
                const opacitySlider = document.getElementById('opacity-slider');
                const opacityValue = document.getElementById('opacity-value');
                if (opacitySlider && opacityValue) {
                    opacitySlider.value = settings.general.opacity;
                    opacityValue.textContent = settings.general.opacity + '%';
                }
            }

            // Click through
            if (settings.general.clickThrough !== undefined) {
                const checkbox = document.getElementById('click-through-checkbox');
                if (checkbox) {
                    checkbox.checked = settings.general.clickThrough;
                }
            }

            // Autostart
            if (settings.general.autostart !== undefined) {
                const checkbox = document.getElementById('autostart-checkbox');
                if (checkbox) {
                    checkbox.checked = settings.general.autostart;
                }
            }

            // Autodetect
            if (settings.general.autodetect !== undefined) {
                const checkbox = document.getElementById('autodetect-checkbox');
                if (checkbox) {
                    checkbox.checked = settings.general.autodetect;
                }
            }

            // Current game
            if (settings.general.currentGame) {
                const select = document.getElementById('game-select');
                if (select) {
                    select.value = settings.general.currentGame;
                }
            }
        }

        // Module settings
        if (settings.modules) {
            // Price check
            if (settings.modules.price_check !== undefined) {
                const checkbox = document.getElementById('price-check-checkbox');
                if (checkbox) {
                    checkbox.checked = settings.modules.price_check;
                }
            }

            // Build guide
            if (settings.modules.build_guide !== undefined) {
                const checkbox = document.getElementById('build-guide-checkbox');
                if (checkbox) {
                    checkbox.checked = settings.modules.build_guide;
                }
            }

            // Map overlay
            if (settings.modules.map_overlay !== undefined) {
                const checkbox = document.getElementById('map-overlay-checkbox');
                if (checkbox) {
                    checkbox.checked = settings.modules.map_overlay;
                }
            }
        }

        // Hotkey settings
        if (settings.hotkeys) {
            // Toggle overlay
            if (settings.hotkeys['1000']) {
                const element = document.getElementById('toggle-overlay-hotkey');
                if (element) {
                    element.textContent = settings.hotkeys['1000'];
                }
            }

            // Price check
            if (settings.hotkeys['1001']) {
                const element = document.getElementById('price-check-hotkey');
                if (element) {
                    element.textContent = settings.hotkeys['1001'];
                }
            }

            // Settings
            if (settings.hotkeys['1004']) {
                const element = document.getElementById('settings-hotkey');
                if (element) {
                    element.textContent = settings.hotkeys['1004'];
                }
            }
        }
    }

    // Save settings
    function saveSettings() {
        const opacitySlider = document.getElementById('opacity-slider');
        const clickThroughCheckbox = document.getElementById('click-through-checkbox');
        const autostartCheckbox = document.getElementById('autostart-checkbox');
        const autodetectCheckbox = document.getElementById('autodetect-checkbox');
        const gameSelect = document.getElementById('game-select');
        const priceCheckCheckbox = document.getElementById('price-check-checkbox');
        const buildGuideCheckbox = document.getElementById('build-guide-checkbox');
        const mapOverlayCheckbox = document.getElementById('map-overlay-checkbox');

        const settings = {
            general: {
                opacity: opacitySlider ? parseInt(opacitySlider.value) : 80,
                clickThrough: clickThroughCheckbox ? clickThroughCheckbox.checked : true,
                autostart: autostartCheckbox ? autostartCheckbox.checked : false,
                autodetect: autodetectCheckbox ? autodetectCheckbox.checked : true,
                currentGame: gameSelect ? gameSelect.value : 'None'
            },
            modules: {
                price_check: priceCheckCheckbox ? priceCheckCheckbox.checked : false,
                build_guide: buildGuideCheckbox ? buildGuideCheckbox.checked : false,
                map_overlay: mapOverlayCheckbox ? mapOverlayCheckbox.checked : false
            }
        };

        sendMessage({
            action: 'save_settings',
            settings: settings
        });
    }

    // Hotkey recording
    let currentlyRecordingHotkey = false;
    let currentlyRecordingHotkeyId = 0;
    let currentlyRecordingHotkeyElement = '';

    function startHotkeyRecording(hotkeyId, elementId) {
        // If already recording, stop
        if (currentlyRecordingHotkey) {
            const prevElement = document.getElementById(currentlyRecordingHotkeyElement);
            if (prevElement) {
                prevElement.classList.remove('recording');
            }
            stopHotkeyRecording();
        }

        // Start recording
        currentlyRecordingHotkey = true;
        currentlyRecordingHotkeyId = hotkeyId;
        currentlyRecordingHotkeyElement = elementId;

        // Update UI
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = 'Press a key...';
            element.classList.add('recording');
        }

        // Notify native
        sendMessage({
            action: 'hotkey_recording_start',
            hotkeyId: hotkeyId
        });
    }

    function stopHotkeyRecording() {
        currentlyRecordingHotkey = false;

        // Notify native
        sendMessage({
            action: 'hotkey_recording_stop'
        });
    }

    // Convert key code to string
    function keyCodeToString(keyCode) {
        // Handle special keys
        switch (keyCode) {
            case 27: return 'Esc';
            case 112: return 'F1';
            case 113: return 'F2';
            case 114: return 'F3';
            case 115: return 'F4';
            case 116: return 'F5';
            case 117: return 'F6';
            case 118: return 'F7';
            case 119: return 'F8';
            case 120: return 'F9';
            case 121: return 'F10';
            case 122: return 'F11';
            case 123: return 'F12';
            case 9: return 'Tab';
            case 13: return 'Enter';
            case 32: return 'Space';
            case 46: return 'Del';
            case 36: return 'Home';
            case 35: return 'End';
            case 33: return 'PgUp';
            case 34: return 'PgDn';
            case 37: return 'Left';
            case 38: return 'Up';
            case 39: return 'Right';
            case 40: return 'Down';
            case 45: return 'Ins';
        }

        // Handle letters and numbers
        if (keyCode >= 48 && keyCode <= 57) {
            return String.fromCharCode(keyCode); // 0-9
        }

        if (keyCode >= 65 && keyCode <= 90) {
            return String.fromCharCode(keyCode); // A-Z
        }

        // Unknown key
        return 'Key(' + keyCode + ')';
    }

    // Listen for events from C++ host
    window.addEventListener('message', function(event) {
        try {
            const message = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;

            if (message.action === 'load_settings') {
                loadSettings(message.settings);
            } else if (message.action === 'settings_saved') {
                // Show saved notification if needed
                console.log('Settings saved successfully');
            }
        } catch (e) {
            console.error('Error processing message from C++:', e);
        }
    });

    // Expose global function for C++ to call
    window.handleNexileMessage = function(messageData) {
        try {
            const message = typeof messageData === 'string' ? JSON.parse(messageData) : messageData;

            if (message.action === 'load_settings') {
                loadSettings(message.settings);
            } else if (message.action === 'settings_saved') {
                console.log('Settings saved successfully');
            }
        } catch (e) {
            console.error('Error handling Nexile message:', e);
        }
    };

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeSettings);
    } else {
        initializeSettings();
    }
</script>
</body>
</html>